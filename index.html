<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hex Map Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">

</head>
<body>
<!-- partial:index.partial.html -->
<div class="header container-fluid" id="header-content">
  <div class="title-bar">
    <h1>Pointy-Top Hex Map Viewer</h1>
    <div class="header-info">

    </div>
  </div>

  <div class="map-url-container mb-3">
    <label for="map-url">Map URL:</label>
    <div class="url-input-group input-group">
      <input type="text" class="form-control form-control-sm" id="map-url" placeholder="Enter map image URL here or leave blank for default">
      <button id="load-url-btn" class="btn btn-primary btn-sm">Load Map</button>
    </div>
  </div>

  <div class="controls-section">
    <div class="controls" id="grid-settings-panel">
      <h2>Grid Settings</h2>
      <div class="control-group">
        <label for="hex-size">Hex Size (px)</label>
        <input type="number" class="form-control form-control-sm" id="hex-size" min="10" max="300" value="40">
      </div>
      <div class="control-group">
        <label for="offset-x">Grid X Offset (px)</label>
        <input type="number" class="form-control form-control-sm" id="offset-x" min="-1000" max="1000" value="0">
      </div>
      <div class="control-group">
        <label for="offset-y">Grid Y Offset (px)</label>
        <input type="number" class="form-control form-control-sm" id="offset-y" min="-1000" max="1000" value="0">
      </div>
      <div class="control-group">
        <label for="columns">Columns</label>
        <input type="number" class="form-control form-control-sm" id="columns" min="1" max="200" value="20">
      </div>
      <div class="control-group">
        <label for="rows">Rows</label>
        <input type="number" class="form-control form-control-sm" id="rows" min="1" max="200" value="15">
      </div>
      <div class="control-group">
        <label for="orientation">Grid Orientation</label>
        <select id="orientation" class="form-select form-select-sm" title="Choose pointy-top or flat-top grid">
          <option value="pointy">Pointy-Top</option>
          <option value="flat">Flat-Top</option>
        </select>
      </div>
      <div class="control-group">
        <label for="map-scale">Map Scale (%)</label>
        <input type="number" class="form-control form-control-sm" id="map-scale" min="10" max="500" value="100" title="Visual scale of the map image itself">
      </div>
    </div>

    <div class="controls" id="appearance-settings-panel">
      <h2>Appearance</h2>
      <div class="control-group">
        <label for="fog-color">Fog Color</label>
        <input type="color" class="form-control form-control-color form-control-sm" id="fog-color" value="#225522">
      </div>
      <div class="control-group">
        <label for="fog-opacity">Fog Opacity</label>
        <input type="range" class="form-range" id="fog-opacity" min="0" max="1" step="0.05" value="0.85">
      </div>
      <div class="control-group">
        <label for="grid-color">Grid Line Color</label>
        <input type="color" class="form-control form-control-color form-control-sm" id="grid-color" value="#FFFFFF">
      </div>
      <div class="control-group">
        <label for="grid-thickness">Grid Line Thickness</label>
        <input type="range" class="form-range" id="grid-thickness" min="0.1" max="5" step="0.1" value="1">
      </div>
    </div>
  </div>

  <div class="button-row d-flex flex-wrap gap-2 mt-3 pt-3 border-top">
    <button id="toggle-mode-btn" class="btn btn-primary btn-sm">Mode: Reveal</button>
    <button id="add-token-btn" class="btn btn-info btn-sm">Add Token</button>
    <button id="remove-token-btn" class="btn btn-warning btn-sm">Remove Token</button>
    <button id="reset-view-btn" class="btn btn-info btn-sm">Reset View</button>
    <button id="reset-map-btn" class="btn btn-danger btn-sm">Reset Fog</button>
    <button id="clear-tokens-btn" class="btn btn-danger btn-sm">Clear Tokens</button>
    <button id="debug-toggle" class="btn btn-secondary btn-sm">Toggle Debug</button>
    <button id="export-btn" class="btn btn-success btn-sm">Export State</button>
    <div class="file-input-container">
      <button class="btn btn-success btn-sm">Import State</button>
      <input type="file" id="import-file" class="file-input" accept=".json">
    </div>
  </div>
</div>

<div class="header-toggle position-fixed top-0 end-0 m-2">
  <button id="toggle-header-btn" class="btn btn-primary btn-sm"><i class="bi bi-caret-up-fill"></i></button>
</div>

  <div class="map-container" id="map-container">
    <canvas id="map-layer" class="map-layer"></canvas>
    <canvas id="grid-layer" class="map-layer"></canvas>
    <canvas id="token-layer" class="map-layer"></canvas>
    <div class="loading" id="loading">Loading map...</div>
    <div id="token-tooltip" class="token-tooltip"></div>
  </div>

<div id="info-bar">
  <span id="zoom-display">Zoom: 100%</span>
  <span id="coord-display">Hex: ---</span>
  <div id="status-indicator"></div>
  <button id="undo-btn" class="btn btn-secondary btn-sm" disabled>Undo</button>
  <button id="redo-btn" class="btn btn-secondary btn-sm" disabled>Redo</button>
</div>

<div id="debug-info"></div>

<div id="export-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Export Map State</h2>
      <span class="close" id="export-modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <p>Copy the following JSON to save your map state:</p>
      <textarea id="export-json" readonly></textarea>
    </div>
    <div class="modal-footer">
      <button id="copy-json-btn" class="btn btn-primary btn-sm">Copy to Clipboard</button>
      <button id="download-json-btn" class="btn btn-success btn-sm">Download as File</button>
    </div>
  </div>
</div>

<div id="token-label-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Token Label</h2>
      <span class="close" id="token-label-modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <select id="token-icon-select" class="form-select mb-2">
        <option value="">-- None --</option>
        <option value="star">star</option>
        <option value="flag">flag</option>
        <option value="person">person</option>
        <option value="location_on">location_on</option>
      </select>
      <input type="text" id="token-label-input" class="form-control mb-2" placeholder="Enter label (optional)">
      <label for="token-color" class="form-label">Token Color</label>
      <input type="color" class="form-control form-control-color form-control-sm mb-2" id="token-color" value="#FF0000">
      <textarea id="token-notes-input" class="form-control" rows="3" placeholder="Enter notes (optional)"></textarea>
    </div>
    <div class="modal-footer">
      <button id="token-label-confirm" class="btn btn-primary btn-sm">Add Token</button>
      <button id="token-label-cancel" class="btn btn-secondary btn-sm">Cancel</button>
    </div>
  </div>
</div>
<!-- partial -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Global error handling -->
  <script>
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.message, event.error);
      if (window.showStatus) {
        showStatus('Unexpected error: ' + event.message, 'error');
      } else {
        var el = document.getElementById('status-indicator');
        if (el) {
          el.style.backgroundColor = '#e53e3e';
          el.textContent = 'Unexpected error: ' + event.message;
          el.style.display = 'inline-block';
        }
      }
    });

    window.addEventListener('unhandledrejection', function(event) {
      var msg = event.reason && event.reason.message ? event.reason.message : event.reason;
      console.error('Unhandled promise rejection:', event.reason);
      if (window.showStatus) {
        showStatus('Unhandled promise: ' + msg, 'error');
      } else {
        var el = document.getElementById('status-indicator');
        if (el) {
          el.style.backgroundColor = '#e53e3e';
          el.textContent = 'Unhandled promise: ' + msg;
          el.style.display = 'inline-block';
        }
      }
    });
  </script>

  <script type="module" src="./script.js"></script>

</body>
</html>
